
# Create GitHub Action Repository Variables for your version of the application:
#   SSC_URL                     - SSC URL for your environment
#   SSC_API_URL                 - SSC API URL for your tenant (e.g. https://api.ams,fortify.com)
#   SSC_APPNAME_POSTFIX         - A postfix string to apply to the application to make it unique, set to empty to use DEFAULT_APP_NAME
#   SSC_PARENT_APPVER_NAME      - SSC application version name corresponding to the parent branch of any newly created branch, this is typically "main" or "develop"
#   SSC_DEFAULT_OWNER           - The user id of the Application Owner (only needed if an application does not already exist)
# Create GitHub Action Secrets for your version of the application:
#   SSC_TOKEN should be a secret containing the SSC CI Token obtained from your SSC tenant.
#   SC_SAST_CLIENT_AUTH_TOKEN should be a secret for the API Key obtained from your SSC tenant.
# Helpful hints:
#   

name: Security Scan (Scancentral)
permissions:
  # required for all workflows
  security-events: write
  # required to fetch internal or private CodeQL packs
  packages: read
  # only required for workflows in private repositories
  actions: read
  # required to create PR comments, new files etc
  contents: write

on:
  # Triggers the workflow on push or pull request events but only for the main or develop branches
  push:
    paths-ignore:
      - '.github/**/**'
      - 'doc/**'
      - 'etc/**'
      - 'files/**'
      - 'media/**'
      - '*.md'
      - 'LICENSE'
    #branches-ignore:
    #  - main
    #  - develop
    branches:
      - '**'        # matches every branch
  pull_request:
    branches: [ main, develop ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
    inputs:
      runBUT:
        description: 'Carry out Build and Unit Testing'
        required: false
        default: 'true'  
      runScancentralSASTScan:
        description: 'Carry out SAST scan using Scancentral'
        required: false
        default: 'true'  

# Global environment variables
env:
  DEFAULT_APP_NAME: "SAP_ABAP_Demo"
  DEFAULT_PARENT_RELEASE_NAME: "main"

jobs:

  Env-Prepare:
    runs-on: ubuntu-latest
    outputs:
      SSC_APPVER: ${{ steps.commands.outputs.SSC_APPVER }}
      SSC_PARENT_APPVER: ${{ steps.commands.outputs.SSC_PARENT_APPVER }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up environment variables
        id: commands
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "Running in a pull request pipeline ..."
            echo "SSC_APPVER=${{ env.DEFAULT_APP_NAME }}${{ vars.SSC_APPNAME_POSTFIX }}:merge-to-${{ github.base_ref }}#PR${{ github.event.number }}" >> $GITHUB_OUTPUT
            echo "SSC_PARENT_APPVER=${{ env.DEFAULT_APP_NAME }}${{ vars.SSC_APPNAME_POSTFIX }}:${{ github.head_ref }}" >> $GITHUB_OUTPUT
          else
            echo "Running in a branch pipeline ..."
            echo "SSC_APPVER=${{ env.DEFAULT_APP_NAME }}${{ vars.SSC_APPNAME_POSTFIX }}:${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "SSC_PARENT_APPVER=${{ env.DEFAULT_APP_NAME }}${{ vars.SSC_APPNAME_POSTFIX }}:${{ env.DEFAULT_PARENT_RELEASE_NAME }}" >> $GITHUB_OUTPUT
          fi

  Build-And-Unit-Test:
    runs-on: ubuntu-latest
    if: ${{ (github.event_name == 'push') || (github.event_name == 'pull_request') || (github.event.inputs.runBUT == 'true') }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - uses: actions/setup-node@v5
        with:
          node-version: '22'
      - name: Run abaplint
        id: abaplint
        continue-on-error: true
        run: |
          npm -g install @abaplint/cli
          abaplint
          - name: Report abaplint status
      - name: Report abaplint status
        run: |
          if [[ "${{ steps.abaplint.outcome }}" == "failure" ]]; then
            echo "⚠️ abaplint found code quality issues but workflow continues"
            echo "Review the abaplint output above for code quality improvements"
          else
            echo "✅ abaplint validation passed"
          fi

  ScanCentral-SAST-Scan:
    runs-on: ubuntu-latest
    if: ${{ (github.event_name == 'push') || (github.event_name == 'pull_request') || (github.event.inputs.runScancentralSASTScan == 'true') }}
    needs: [ Env-Prepare, Build-And-Unit-Test ]
    env: 
      SSC_APPVER: ${{ needs.Env-Prepare.outputs.SSC_APPVER }}
      SSC_PARENT_APPVER: ${{ needs.Env-Prepare.outputs.SSC_PARENT_APPVER }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      #
      # See: https://github.com/marketplace/actions/fortify-ast-scan
      #
      - name: Run ScanCentral SAST & Debricked scan
        uses: fortify/github-action@v2
        with:
          sast-scan: true
          debricked-sca-scan: false # not valid for ABAP code
        env:
          SSC_URL: ${{vars.SSC_URL}}
          SSC_TOKEN: ${{secrets.SSC_TOKEN}}
          SC_SAST_TOKEN: ${{secrets.SC_SAST_CLIENT_AUTH_TOKEN}}
          # SSC_LOGIN_EXTRA_OPTS: --socket-timeout=60s
          #DEBRICKED_TOKEN: ${{secrets.DEBRICKED_TOKEN}}
          SSC_APPVERSION: ${{ env.SSC_APPVER }}
          # DO_SETUP: true
          # SETUP_ACTION: https://scm.my.org/shared-repos/fcli-actions/setup.yaml
          SETUP_EXTRA_OPTS: ${{ format('--copy-from "{0}" --sdlc-status Development --issue-template {1}', env.SSC_PARENT_APPVER, 'Prioritized High Risk Issue Template') }} 
          # SC_CLIENT_VERSION: 24.4.1
          # DO_PACKAGE_DEBUG: true
          PACKAGE_EXTRA_OPTS: -exclude "docs" -exclude "files"
          # SC_SAST_SENSOR_VERSION: 24.4.1
          EXTRA_SC_SAST_SCAN_OPTS: -rules ./etc/custom_abap_rules.xml
          # DO_WAIT: true
          DO_POLICY_CHECK: true
          # POLICY_CHECK_ACTION: https://scm.my.org/shared-repos/fcli-actions/check-policy.yaml
          # POLICY_CHECK_EXTRA_OPTS: --on-unsigned=ignore
          DO_JOB_SUMMARY: true
          # JOB_SUMMARY_ACTION: https://scm.my.org/shared-repos/fcli-actions/job-summary.yaml
          # JOB_SUMMARY_EXTRA_OPTS: --on-unsigned=ignore
          DO_PR_COMMENT: true
          # PR_COMMENT_ACTION: https://scm.my.org/shared-repos/fcli-actions/github-pr-comment.yaml
          # PR_COMMENT_EXTRA_OPTS: --on-unsigned=ignore
          DO_EXPORT: true
          # EXPORT_ACTION: https://scm.my.org/shared-repos/fcli-actions/github-sast-report.yaml
          # EXPORT_EXTRA_OPTS: --on-unsigned=ignore
          # TOOL_DEFINITIONS: https://ftfy.mycompany.com/tool-definitions/v1/tool-definitions.yaml.zip
